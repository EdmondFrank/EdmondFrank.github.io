<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: linux,ruby,编程 | EdmondFrank's 时光足迹]]></title>
  <link href="http://edmondfrank.github.io/blog/categories/linux-ruby-bian-cheng/atom.xml" rel="self"/>
  <link href="http://edmondfrank.github.io/"/>
  <updated>2017-05-12T19:37:52+08:00</updated>
  <id>http://edmondfrank.github.io/</id>
  <author>
    <name><![CDATA[EdmondFrank]]></name>
    <email><![CDATA[EdmomdFrank@yahoo.co.jp]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Ruby实现的天翼校园网客户端]]></title>
    <link href="http://edmondfrank.github.io/blog/2016/07/02/rubyshi-xian-de-tian-yi-xiao-yuan-wang-ke-hu-duan/"/>
    <updated>2016-07-02T20:33:30+08:00</updated>
    <id>http://edmondfrank.github.io/blog/2016/07/02/rubyshi-xian-de-tian-yi-xiao-yuan-wang-ke-hu-duan</id>
    <content type="html"><![CDATA[<h2>Ruby实现的天翼校园网客户端</h2>

<p>众所周知,由于Linux客户量在国内十分少,因此十分多的国内软件商都很少有提供Linux下的客户端. 即使是<a href="http://zsteduapp.10000.gd.cn/index.html">天翼校园网</a>也不例外. 这样便苦了我们这一批在校学习的大学学子们了.</p>

<p>为了尝试去解决这样的困境,我通过模拟天翼校园网Windows客户端的post登录协议,成功登录了校园网.</p>

<p>在此,将核心POST代码放出供大家参考(Ruby实现),完整代码可以前往我的<a href="https://github.com/EdmondFrank/Esurfing">github</a>浏览和下载.</p>

<pre><code class="ruby">#!/usr/bin/ruby
#coding:utf-8
require 'json'
require 'mechanize'
require 'digest/md5'
def getTimestamp()
  return Time.now.to_i.to_s+'520'
end
def getmac()
  return `(ifconfig $i|grep "eth"|awk '{print$5}'|sed 's/:/-/g'|tr '[a-z]' '[A-Z]')`.strip
end
def vaildmac?(mac)
   return mac=~/^(([\d|a-fA-F]{2}-){5}[\d|a-fA-F]{2})$/ ? true : false
end
def vaildip?(ip)
  return ip =~/((?:(?:25[0-5]|2[0-4]\d|((1\d{2})|([1-9]?\d)))\.){3}(?:25[0-5]|2[0-4]\d|((1\d{2})|([1-9]?\d))))/ ? true : false
end
#mac=1a-2b-3c-4d-5e-33; if echo $mac | grep -qiP "^([\dA-F]{2}-){5}[\dA-F]{2}$"; then echo $mac yes; else echo $mac no; fi
def getlocalip()
  ip=`(ifconfig $i | grep "inet " | awk -F: '{print $2}' | awk '{print $1}')`
  return ip.gsub("127.0.0.1","").strip
end
def getmd5(str)
  return  Digest::MD5.hexdigest(str+'Eshore!@#').upcase
end


def active(username,clientip,nasip,mac)
  timestamp = getTimestamp
  authenticator= getmd5(clientip+nasip+mac+timestamp)
  url="http://enet.10000.gd.cn:8001/hbservice/client/active?username=#{username}&amp;clientip=#{clientip}&amp;nasip=#{nasip}&amp;mac=#{mac}&amp;timestamp=#{timestamp}&amp;authenticator=#{authenticator}"

  agent = Mechanize.new
  page = agent.get(url)
  puts page.body
end

def login(username,password,clientip,nasip,mac,code,iswifi)
  url = "http://enet.10000.gd.cn:10001/client/login"
  timestamp = getTimestamp
  authenticator=getmd5(clientip+nasip+mac+timestamp+code)
  postdata={}
  postdata['username']=username
  postdata['password']=password
  postdata['clientip']=clientip
  postdata['nasip']=nasip
  postdata['mac']=mac
  postdata['timestamp']=timestamp
  postdata['authenticator']=authenticator
  postdata['iswifi']=iswifi
  data=postdata.to_json

  agent = Mechanize.new
  resp = agent.post(url,data)
  status = JSON.parse(resp.body)['resinfo']
  return  "登陆信息回馈:"+status
end


def challenge(username,clientip,nasip,mac)
  url = 'http://enet.10000.gd.cn:10001/client/challenge'

  timestamp = getTimestamp
  authenticator= getmd5(clientip+nasip+mac+timestamp)
  postdata={}
  postdata['username']=username
  postdata['clientip']=clientip
  postdata['nasip']=nasip
  postdata['mac']=mac
  postdata['timestamp']=timestamp
  postdata['authenticator']=authenticator
  data=postdata.to_json
  headers = {'X-Forwarded_For' =&gt; clientip}

  agent = Mechanize.new
  resp = agent.post(url,data,headers)
  result = JSON.parse(resp.body)
  puts result
  return result['challenge']
end
</code></pre>
]]></content>
  </entry>
  
</feed>
